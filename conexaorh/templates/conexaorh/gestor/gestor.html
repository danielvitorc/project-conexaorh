{% load static %}
<!DOCTYPE html>
<html lang="pt-br" data-theme="light">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="icon" href="https://encrypted-tbn2.gstatic.com/faviconV2?url=https://www.nortetech.net&client=VFE&size=64&type=FAVICON&fallback_opts=TYPE,SIZE,URL&nfrp=2" type="image/png">
    <title>{% block title %}Página do Gestor - RH{% endblock %}</title>

    <!-- ================== CSS ================== -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="{% static 'conexaorh/css/gestor.css' %}">
    
    <!-- Os scripts JS foram movidos para o final do <body> -->
</head>
<body>

{% include 'conexaorh/include/navbar.html' with pagina_ativa='gestor_page' botao_movimentacao=True %}

<div class="main-content">
    <!-- Card de boas-vindas -->
    <div class="card-welcome">
        <div class="welcome-text">
            <h1 class="mb-4">Bem-vindo à Página do Gestor, {{ usuario.first_name }}</h1>
            <p>Esta é a área exclusiva para usuários do tipo Gestor.</p>
        </div>
        <div class="user-profile">
            <div class="profile-info">
                <span class="user-name">{{ usuario.first_name }} {{ usuario.last_name }}</span>
                <span class="user-role">{{ usuario.get_user_type_display }}</span>
            </div>
            <div class="dropdown-container">
                <span class="dropdown-icon" onclick="toggleDropdown(  )">
                    <i class="fa fa-chevron-down"></i>
                </span>
                <div id="userDropdown" class="dropdown-menu">
                    <a href="{% url 'logout' %}" class="dropdown-item logout">
                        <i class="fas fa-sign-out-alt"></i> Sair
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Seção de Ações Rápidas com os 3 Cards -->
    <div class="container-fluid mt-4">
        <h3 class="mb-3">Ações Rápidas</h3>
        <div class="row g-4">
            <!-- Card Requisição de Pessoal -->
            <div class="col-lg-4 col-md-6">
                <div class="card-welcome shadow-sm h-100 text-center action-card">
                    <div class="card-body d-flex flex-column">
                        <i class="fas fa-users fa-3x text-primary mb-3"></i>
                        <h5 class="card-title">Requisição de Pessoal</h5>
                        <p class="card-text">Solicite novas contratações de forma rápida e organizada.</p>
                        <div class="mt-auto">
                            <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalRp">
                                Abrir Formulário
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Card Movimentação de Pessoal -->
            <div class="col-lg-4 col-md-6">
                <div class="card-welcome shadow-sm h-100 text-center action-card">
                    <div class="card-body d-flex flex-column">
                        <i class="fas fa-exchange-alt fa-3x text-warning mb-3"></i>
                        <h5 class="card-title">Movimentação de Pessoal</h5>
                        <p class="card-text">Registre promoções ou transferências internas com facilidade.</p>
                        <div class="mt-auto">
                            <button type="button" class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#modalMov">
                                Abrir Formulário
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Card Requisição de Desligamento -->
            <div class="col-lg-4 col-md-12">
                <div class="card-welcome shadow-sm h-100 text-center action-card">
                    <div class="card-body d-flex flex-column">
                        <i class="fas fa-user-times fa-3x text-danger mb-3"></i>
                        <h5 class="card-title">Requisição de Desligamento</h5>
                        <p class="card-text">Solicite desligamentos de colaboradores com o devido registro.</p>
                        <div class="mt-auto">
                            <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#modalRd">
                                Abrir Formulário
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Linha Amarela Divisória -->
    <div class="linha-amarela my-5"></div>
    
    <!-- Tabela de Movimentações Pendentes -->
    <div class="container-fluid">
        <div class="card-tabela-estilizada">
            <div class="tabela-header">
                <h3><i class="fas fa-tasks text-info me-2"></i>Movimentações Pendentes como Gestor Proposto</h3>
            </div>
            <div class="table-responsive">
                <table id="tabela-movimentacoes" class="tabela-moderninha display nowrap w-100">
                    <thead>
                        <tr>
                            <th>Gestor Atual</th>
                            <th>Colaborador</th>
                            <th>Cargo Proposto</th>
                            <th>Data Solicitação</th>
                            <th>Sua Assinatura</th>
                            <th>Data Aprovação</th>
                            <th>Tempo para Aprovar</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for registro in movimentacao %}
                        <tr>
                            <td>{{ registro.gestor_atual }}</td>
                            <td>{{ registro.colaborador_movimentado }}</td>
                            <td>{{ registro.cargo_proposto }}</td>
                            <td>{{ registro.data_solicitacao|date:"d/m/Y H:i" }}</td>
                            <td>
                                {% if registro.assinatura_gestor_proposto %}
                                    <span class="text-success"><i class="fa-solid fa-check"></i> Assinado</span>
                                {% else %}
                                    <form method="post" enctype="multipart/form-data" class="d-inline">
                                        {% csrf_token %}
                                        {{ form.assinatura_gestor_proposto }} 
                                        <input type="hidden" name="registro_id" value="{{ registro.id }}">
                                        <button type="submit" name="submit_aprovacao_mov" class="btn btn-sm btn-outline-success">
                                            Aprovar
                                        </button>
                                    </form>
                                {% endif %}
                            </td>
                            <td>
                                {% if registro.assinatura_gestor_proposto %}
                                    {{ registro.data_autorizacao_gestor_proposto|date:"d/m/Y H:i" }}
                                {% else %}
                                    <span class="text-muted">Pendente</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if registro.dias_para_autorizacao_gestor_proposto is not None %}
                                    {% if registro.dias_para_autorizacao_gestor_proposto == 0 %}
                                        Aprovado no mesmo dia
                                    {% else %}
                                        {{ registro.dias_para_autorizacao_gestor_proposto }} dias
                                    {% endif %}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center text-muted py-4">Não há movimentações aguardando sua aprovação.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- =================================================================== -->
<!-- =================== MODAIS DE FORMULÁRIO =================== -->
<!-- =================================================================== -->

<!-- Modal Requisição de Pessoal -->
<div class="modal fade" id="modalRp" tabindex="-1" aria-labelledby="modalRpLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalRpLabel">Requisição de Pessoal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="form-flow-hint">Preencha os dados da vaga, o perfil do candidato e os benefícios.</p>
                <form method="post" name="submit_rp">
                    {% csrf_token %}
                    <h3 class="section-title">Informações da Vaga</h3>
                    <div class="form-grid">
                        {{ form_rp.as_p }}
                    </div>
                    <div class="modal-footer mt-4">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" name="submit_rp" class="btn btn-primary">Registrar Requisição</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal Movimentação de Pessoal -->
<div class="modal fade" id="modalMov" tabindex="-1" aria-labelledby="modalMovLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalMovLabel">Movimentação de Pessoal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="form-flow-hint">Informe os dados da movimentação, como setor, motivo e nova função.</p>
                <form method="post" name="submit_movimentacao">
                    {% csrf_token %}
                    <h3 class="section-title">Dados da Movimentação</h3>
                    <div class="form-grid">
                        {{ form_movimentacao.as_p }}
                    </div>
                    <div class="modal-footer mt-4">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" name="submit_movimentacao" class="btn btn-warning">Registrar Movimentação</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal Requisição de Desligamento -->
<div class="modal fade" id="modalRd" tabindex="-1" aria-labelledby="modalRdLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalRdLabel">Requisição de Desligamento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="form-flow-hint">Preencha os dados da solicitação, justificativa e prazos.</p>
                <form method="post" name="submit_rd">
                    {% csrf_token %}
                    <h3 class="section-title">Detalhes do Desligamento</h3>
                    <div class="form-grid">
                        {{ form_rd.as_p }}
                    </div>
                    <div class="modal-footer mt-4">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" name="submit_rd" class="btn btn-danger">Registrar Desligamento</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmação (se necessário) -->
<div class="modal fade" id="modalConfirmacao" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmação</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Deseja realizar também uma Requisição de Pessoal?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Não</button>
                <button type="button" class="btn btn-primary" id="confirmarRequisicaoBtn">Sim</button>
            </div>
        </div>
    </div>
</div>


<!-- =================================================================== -->
<!-- =================== SCRIPTS DA PÁGINA =================== -->
<!-- =================================================================== -->

<!-- CORREÇÃO: Todos os scripts foram movidos para o final do <body> e na ordem correta -->

<!-- 2. Bootstrap JS (depende do jQuery ) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- 3. DataTables (depende do jQuery ) -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<!-- 4. Select2 (depende do jQuery ) -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- 5. Seu script personalizado (depende de todas as bibliotecas acima ) -->
<script>
    // Script para o dropdown do perfil de usuário
    function toggleDropdown() {
        const menu = document.getElementById("userDropdown");
        menu.style.display = menu.style.display === "block" ? "none" : "block";
    }

    document.addEventListener("click", function (e) {
        const dropdown = document.getElementById("userDropdown");
        const icon = document.querySelector(".dropdown-icon");
        if (dropdown && icon && !dropdown.contains(e.target) && !icon.contains(e.target)) {
            dropdown.style.display = "none";
        }
    });

    // Inicialização do DataTable e Lógica dos Modais
    $(document).ready(function () {
        // Inicializa a tabela
        $('#tabela-movimentacoes').DataTable({
            responsive: true,
            pageLength: 5,
            lengthMenu: [5, 10, 15, 20, "Todos"],
            language: {
                url: "https://cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json",
                emptyTable: "Não há movimentações aguardando sua aprovação."
            },
            order: [[ 3, 'desc' ]]
        } );

        // Solução para o problema dos modais fechando sozinhos com Select2
        function inicializarSelect2(modalElement) {
            // Encontra todos os campos com a classe .select2-field dentro do modal específico
            $(modalElement).find('.select2-field').each(function() {
                // Verifica se o campo já foi inicializado para evitar duplicação
                if (!$(this).data('select2')) { 
                    $(this).select2({
                        dropdownParent: $(modalElement), // Anexa o dropdown ao modal
                        width: '100%'
                    });
                }
            });
        }

        // Adiciona um listener para quando QUALQUER modal for aberto
        $('.modal').on('shown.bs.modal', function () {
            inicializarSelect2(this); // 'this' é o elemento do modal que foi aberto
        });

        // Lógica para o modal de confirmação
        const urlParams = new URLSearchParams(window.location.search);
        const abrirConfirmacao = urlParams.get('confirmacao') === 'true';

        if (abrirConfirmacao) {
            const modalConfirmacao = new bootstrap.Modal(document.getElementById('modalConfirmacao'));
            modalConfirmacao.show();
            // Remove o parâmetro da URL para não reabrir ao recarregar a página
            if (window.history.replaceState) {
                const url = new URL(window.location);
                url.searchParams.delete('confirmacao');
                window.history.replaceState({ path: url.href }, '', url.href);
            }
        }

        $('#confirmarRequisicaoBtn').on('click', function() {
            const modalConfirmacao = bootstrap.Modal.getInstance(document.getElementById('modalConfirmacao'));
            const modalRp = new bootstrap.Modal(document.getElementById('modalRp'));
            if (modalConfirmacao) {
                modalConfirmacao.hide();
            }
            modalRp.show();
        });
    });
</script>

<script src="{% static 'conexaorh/js/tema.js' %}"></script>

</body>
</html>
